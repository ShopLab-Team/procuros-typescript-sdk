name: Publish to npm

# Triggered when a GitHub Release is published (via the Releases UI or gh release create).
# The release tag must match the version in package.json (e.g. v1.2.3 → 1.2.3).
#
# ─── npm Trusted Publishing (Provenance) ────────────────────────────────────
# This workflow uses npm's provenance attestation feature. When --provenance is
# passed, npm uses the GitHub OIDC token (id-token: write) to generate a signed
# SLSA provenance statement that is attached to the published package. Anyone can
# verify it came from this exact repo, commit, and workflow run.
#
# Prerequisites (one-time setup):
#   1. Create an npm Granular Access Token:
#        https://www.npmjs.com/settings/<username>/tokens
#        Type:    Granular Access Token
#        Scope:   Read and Write → Packages and scopes → @shoplab/procuros-sdk
#        Expiry:  Set to suit your rotation policy (365 days is common)
#   2. Add it as a GitHub secret:
#        Repo → Settings → Secrets and variables → Actions → New secret
#        Name:  NPM_TOKEN
#        Value: <the token from step 1>
#   3. (Optional but recommended) Create a GitHub Environment named "npm":
#        Repo → Settings → Environments → New environment → name: npm
#        Add required reviewers or branch protection rules as desired.
#        The `environment: npm` key in the publish job below uses it.
# ─────────────────────────────────────────────────────────────────────────────

on:
  release:
    types: [published]

jobs:
  # ── 1. Verify ────────────────────────────────────────────────────────────────
  # Run tests and validate the release tag matches package.json version before
  # attempting to publish. Keeps npm clean from accidental/broken releases.
  verify:
    name: Verify release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type-check
        run: pnpm type-check

      - name: Run full test suite
        run: pnpm test

      - name: Assert package.json version matches release tag
        run: |
          PKG_VERSION="v$(node -p "require('./package.json').version")"
          TAG_VERSION="${{ github.ref_name }}"
          echo "package.json version : $PKG_VERSION"
          echo "Release tag          : $TAG_VERSION"
          if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::package.json version ($PKG_VERSION) does not match release tag ($TAG_VERSION). Update package.json before creating the release."
            exit 1
          fi

  # ── 2. Publish ───────────────────────────────────────────────────────────────
  publish:
    name: Publish to npm (with provenance)
    needs: verify
    runs-on: ubuntu-latest

    # Scopes this job to the "npm" GitHub Environment (optional).
    # Lets you require manual approval before publishing via Environments UI.
    environment: npm

    permissions:
      # Required by npm --provenance: lets the workflow request a short-lived
      # GitHub OIDC token, which npm uses to sign the provenance attestation.
      id-token: write
      # Required to read the repository source code.
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js with npm registry
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: pnpm
          # Configures .npmrc to point at registry.npmjs.org and injects
          # NODE_AUTH_TOKEN into the npm config automatically.
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Publish
        # --provenance  Attaches a signed SLSA provenance attestation to the
        #               release. Requires id-token: write above.
        #               Verifiable at: npm info @shoplab/procuros-sdk dist-tags
        #               or: https://www.npmjs.com/package/@shoplab/procuros-sdk
        #
        # --access public  Required for scoped packages (@shoplab/procuros-sdk) to be
        #                  publicly installable without authentication.
        #
        # NOTE: We use `npm publish` (not `pnpm publish`) because pnpm does not
        # yet support --provenance end-to-end. The build artifacts in dist/ are
        # already produced by the build step above.
        run: npm publish --provenance --access public
        env:
          # The Granular Access Token you created in npm (see setup instructions above).
          # GitHub Actions injects NODE_AUTH_TOKEN into the .npmrc file that
          # setup-node configured, authenticating the publish request.
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
