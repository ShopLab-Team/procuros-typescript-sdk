name: Publish to npm

# Triggered when a GitHub Release is published (via the Releases UI or
# `gh release create`). The release tag must match the version in package.json
# (e.g. tag v1.0.0 → package.json version 1.0.0).
#
# ─── Publishing to npmjs.com with Provenance ─────────────────────────────────
# This workflow publishes @shoplab/procuros-sdk to the public npm registry at
# https://www.npmjs.com/package/@shoplab/procuros-sdk
#
# The --provenance flag attaches a signed SLSA attestation to each release,
# cryptographically linking the package back to this repo, commit, and workflow.
#
# Prerequisites (one-time setup):
#   1. Create a Granular Access Token on npmjs.com:
#        https://www.npmjs.com/settings/<your-username>/tokens
#        Type:    Granular Access Token
#        Scope:   Read and Write → Packages and scopes → @shoplab
#        Expiry:  Maximum 90 days (npm policy). Set a calendar reminder to rotate.
#   2. Add it as a GitHub secret:
#        https://github.com/ShopLab-Team/procuros-typescript-sdk/settings/secrets/actions
#        Name:  NPM_TOKEN
#        Value: <token from step 1>
#   3. (Optional) Create a GitHub Environment named "npm" for manual approval:
#        https://github.com/ShopLab-Team/procuros-typescript-sdk/settings/environments
# ─────────────────────────────────────────────────────────────────────────────

on:
  release:
    types: [published]

jobs:
  # ── 1. Verify ────────────────────────────────────────────────────────────────
  verify:
    name: Verify release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type-check
        run: pnpm type-check

      - name: Run full test suite
        run: pnpm test

      - name: Assert package.json version matches release tag
        run: |
          PKG_VERSION="v$(node -p "require('./package.json').version")"
          TAG_VERSION="${{ github.ref_name }}"
          echo "package.json version : $PKG_VERSION"
          echo "Release tag          : $TAG_VERSION"
          if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::package.json version ($PKG_VERSION) does not match release tag ($TAG_VERSION). Update package.json before creating the release."
            exit 1
          fi

  # ── 2. Publish ───────────────────────────────────────────────────────────────
  publish:
    name: Publish to npmjs.com (with provenance)
    needs: verify
    runs-on: ubuntu-latest

    # Scopes this job to the "npm" GitHub Environment.
    # Go to Settings → Environments → New environment → name: npm
    # to optionally add required reviewers before each publish.
    environment: npm

    permissions:
      # Required for --provenance: generates a short-lived OIDC token that npm
      # uses to sign the provenance attestation attached to the package.
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js with npmjs.com registry
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: pnpm
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Publish
        # --provenance  Signs the release with a SLSA attestation.
        #               Verifiable at npmjs.com/package/@shoplab/procuros-sdk
        # --access public  Required for scoped packages to be publicly installable.
        # NOTE: Using npm (not pnpm) because pnpm does not support --provenance.
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
