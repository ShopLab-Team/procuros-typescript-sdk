name: Publish to npm

# Triggered when a GitHub Release is published (via the Releases UI or
# `gh release create`). The release tag must match the version in package.json
# (e.g. tag v1.0.0 → package.json version 1.0.0).
#
# ─── npm Trusted Publishing (OIDC) ───────────────────────────────────────────
# This workflow uses npm Trusted Publishing. No stored tokens required.
# GitHub Actions generates a short-lived OIDC token that npm exchanges for a
# scoped publish credential automatically — nothing to rotate or store.
#
# One-time setup (do this AFTER the package exists on npm — see FIRST PUBLISH):
#   1. Go to: https://www.npmjs.com/package/@shoplab/procuros-sdk
#   2. Click "Publishing Access" (right-hand sidebar)
#   3. Under "Trusted Publishers" → "Add a publisher":
#        Publisher type:    GitHub Actions
#        GitHub owner:      ShopLab-Team
#        Repository name:   procuros-typescript-sdk
#        Workflow file:     publish.yml
#        Environment name:  npm   ← must match the `environment:` key below
#   4. Save. Remove NPM_TOKEN secret from GitHub — it is no longer needed.
#
# ─── FIRST PUBLISH (bootstrap) ───────────────────────────────────────────────
# The package must exist on npm before Trusted Publishing can be configured.
# For the very first release only:
#   1. Add a temporary NPM_TOKEN secret (Granular token, @shoplab scope, 90d)
#   2. Set FIRST_PUBLISH=true in the publish step below (uncomment it)
#   3. Publish → the package now exists on npm
#   4. Configure Trusted Publishing on npmjs.com (step above)
#   5. Remove NPM_TOKEN from GitHub secrets
#   6. Remove / re-comment the FIRST_PUBLISH line
# All future releases use OIDC automatically.
# ─────────────────────────────────────────────────────────────────────────────

on:
  release:
    types: [published]

jobs:
  # ── 1. Verify ────────────────────────────────────────────────────────────────
  verify:
    name: Verify release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type-check
        run: pnpm type-check

      - name: Run full test suite
        run: pnpm test

      - name: Assert package.json version matches release tag
        run: |
          PKG_VERSION="v$(node -p "require('./package.json').version")"
          TAG_VERSION="${{ github.ref_name }}"
          echo "package.json version : $PKG_VERSION"
          echo "Release tag          : $TAG_VERSION"
          if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::package.json version ($PKG_VERSION) does not match release tag ($TAG_VERSION). Update package.json before creating the release."
            exit 1
          fi

  # ── 2. Publish ───────────────────────────────────────────────────────────────
  publish:
    name: Publish to npmjs.com
    needs: verify
    runs-on: ubuntu-latest

    # Must match the "Environment name" configured in npm Trusted Publishing.
    # Create it at: https://github.com/ShopLab-Team/procuros-typescript-sdk/settings/environments
    environment: npm

    permissions:
      # OIDC: lets GitHub Actions request a short-lived identity token that npm
      # exchanges for a publish credential. No stored secret required.
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js with npmjs.com registry
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: pnpm
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Publish
        # --provenance  Attaches a signed SLSA attestation (requires id-token: write).
        # --access public  Required for scoped packages to be publicly installable.
        #
        # No NODE_AUTH_TOKEN needed. npm detects the GitHub Actions OIDC environment
        # (enabled by id-token: write above) and exchanges it for a short-lived
        # publish credential automatically via npm Trusted Publishing.
        run: npm publish --provenance --access public
